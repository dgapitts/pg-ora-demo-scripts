## Setup01 and understanding base cost model (seq_page_cost,cpu_tuple_cost,cpu_operator_cost)

### Background setup milano2019 database and user pgconf 
````
pgbench=# create database milano2019;
CREATE DATABASE
pgbench=# create user pgconf with password 'changeme';
CREATE ROLE
pgbench=# -- GRANT ALL PRIVILEGES ON DATABASE milano2019 to pgconf;
pgbench=# GRANT ALL PRIVILEGES ON DATABASE milano2019 to pgconf;
GRANT
pgbench=# \q
~ $ vi ~/.pgpass
~ $ grep pgconf ~/.pgpass
localhost:5432:*:pgconf:changeme
~ $ psql -d milano2019 -U pgconf
psql (11.5)
Type "help" for help.

milano2019=> 
```



### create sample table t_test with 8 million rows

```
~/projects/pg-ora-demo-scripts $ psql -d milano2019 -U pgconf
psql (11.5)
Type "help" for help.

milano2019=> \timing on
Timing is on.
milano2019=> set max_parallel_workers_per_gather = 0;
SET
Time: 8.149 ms
milano2019=> CREATE TABLE t_test (id SERIAL,  name  VARCHAR(20) NOT NULL, salary numeric default random()*10000);
CREATE TABLE
Time: 229.402 ms
milano2019=> \d t_test
                                     Table "public.t_test"
 Column |         Type          | Collation | Nullable |                Default
--------+-----------------------+-----------+----------+----------------------------------------
 id     | integer               |           | not null | nextval('t_test_id_seq'::regclass)
 name   | character varying(20) |           | not null |
 salary | numeric               |           |          | (random() * (10000)::double precision)

milano2019=> insert into t_test (name) values ('dave');
INSERT 0 1
Time: 6.150 ms
milano2019=> insert into t_test (name) values ('thomas');
INSERT 0 1
Time: 0.747 ms
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 2
Time: 2.609 ms
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 4
Time: 1.422 ms
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 8
Time: 0.582 ms
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 16
Time: 1.661 ms
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 32
Time: 1.738 ms
...
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 524288
Time: 2375.452 ms (00:02.375)
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 1048576
Time: 4476.686 ms (00:04.477)
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 2097152
Time: 9015.923 ms (00:09.016)
milano2019=> insert into t_test (name) (select name from t_test);
INSERT 0 4194304
Time: 18092.925 ms (00:18.093)
```


```
milano2019=> explain select * from t_test;
                           QUERY PLAN
-----------------------------------------------------------------
 Seq Scan on t_test  (cost=0.00..87626.84 rows=3419584 width=21)
(1 row)
Time: 3.027 ms

```

```
milano2019=> analyze;
WARNING:  skipping "pg_statistic" --- only superuser or database owner can analyze it
WARNING:  skipping "pg_foreign_table" --- only superuser or database owner can analyze it
...
ANALYZE
Time: 1568.381 ms (00:01.568)
```


```
milano2019=> explain select * from t_test;
                            QUERY PLAN
------------------------------------------------------------------
 Seq Scan on t_test  (cost=0.00..137316.62 rows=8388562 width=21)
(1 row)

Time: 3.787 ms
milano2019=> \x
Expanded display is on.
milano2019=> select * from pg_stats where tablename = 't_test';
-[ RECORD 1 ]----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schemaname             | public
tablename              | t_test
attname                | id
inherited              | f
null_frac              | 0
avg_width              | 4
n_distinct             | -1
most_common_vals       |
most_common_freqs      |
histogram_bounds       | {97,82539,172111,255661,340417,423361,513330,597698,682535,771498,854740,939712,1021013,1102100,1182086,1267014,1351896,1442074,1524827,1610733,1698245,1788121,1875425,1964661,2056766,2145810,2231933,2318917,2388292,2476011,2569266,2653957,2733562,2822486,2907076,2977118,3050738,3131841,3210522,3295620,3375124,3459734,3540148,3619361,3700736,3778942,3861171,3948398,4033476,4113363,4200103,4282744,4361342,4463478,4542268,4614592,4696697,4774084,4848821,4934177,5020069,5111292,5188684,5269194,5353887,5428032,5510908,5589115,5685754,5768794,5854482,5947036,6033072,6112717,6184836,6280883,6364250,6444010,6519412,6606233,6698402,6780169,6870539,6952381,7033660,7126622,7210392,7296180,7377770,7466714,7551256,7637908,7714177,7808491,7888533,7973491,8054537,8136074,8218809,8306750,8388052}
correlation            | 1
most_common_elems      |
most_common_elem_freqs |
elem_count_histogram   |
-[ RECORD 2 ]----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schemaname             | public
tablename              | t_test
attname                | name
inherited              | f
null_frac              | 0
avg_width              | 6
n_distinct             | 2
most_common_vals       | {thomas,dave}
most_common_freqs      | {0.501133,0.498867}
histogram_bounds       |
correlation            | 0.494602
most_common_elems      |
most_common_elem_freqs |
elem_count_histogram   |
-[ RECORD 3 ]----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schemaname             | public
tablename              | t_test
attname                | salary
inherited              | f
null_frac              | 0
avg_width              | 11
n_distinct             | -1
most_common_vals       |
most_common_freqs      |
histogram_bounds       | {0.667017884552479,101.448483765125,194.95340064168,298.703187145293,395.647487603128,498.392726294696,590.949356555939,693.818838335574,787.411439232528,877.812723629177,984.078082256019,1078.14883347601,1182.86073673517,1291.68198909611,1390.04662167281,1495.11785712093,1595.45871429145,1694.55241411924,1788.92381489277,1897.50886522233,2001.0568248108,2100.88497027755,2187.79367394745,2283.0314701423,2385.00164356083,2475.69597326219,2583.48511066288,2680.8733958751,2775.03199875355,2871.14656530321,2966.69580973685,3064.90908376873,3169.87150348723,3279.32455576956,3380.19910268486,3477.02261991799,3569.71812900156,3680.53233716637,3792.64656454325,3898.79488386214,3998.66135790944,4102.00754180551,4202.07749120891,4299.06585253775,4393.39721575379,4488.82934171706,4593.46261806786,4692.77357682586,4803.61947324127,4906.28232713789,5012.26144377142,5111.2962141633,5205.00670652837,5294.44304760545,5393.56870576739,5500.59212371707,5606.48831538856,5699.19406902045,5802.61780880392,5910.01866851002,6009.05727595091,6109.76784490049,6215.72541072965,6313.22829052806,6415.10152257979,6507.01526552439,6608.90483763069,6715.69913160056,6808.26023221016,6897.48692791909,7005.86711987853,7111.29979696125,7211.98438666761,7306.091892533,7419.96207274497,7526.39053855091,7626.45400129259,7719.77378521115,7807.85298906267,7920.27678806335,8027.7097504586,8125.81001315266,8228.12226600945,8321.42458297312,8426.01485550404,8525.65123233944,8634.00626927614,8724.00584630668,8833.15348997712,8931.02012574673,9034.75237078965,9131.41344673932,9221.27392608672,9316.2079108879,9409.57157872617,9505.61995618045,9606.75192531198,9704.8505069688,9802.16627009213,9898.50539714098,9999.5989818126}
correlation            | 0.000106374
most_common_elems      |
most_common_elem_freqs |
elem_count_histogram   |

Time: 17.382 ms
milano2019=> \x off
Expanded display is off.
```

### reviewing default cost settings

```
milano2019=> show seq_page_cost;
 seq_page_cost
---------------
 1
(1 row)

Time: 1.337 ms
milano2019=> show cpu_tuple_cost;
 cpu_tuple_cost
----------------
 0.01
(1 row)

Time: 0.279 ms
milano2019=> show cpu_operator_cost;
 cpu_operator_cost
-------------------
 0.0025
(1 row)

Time: 0.396 ms
```

### Seq Scan on t_test costs = (num_pages*seq_page_cost) + (num_tuples*cpu_tuple_cost)

```
milano2019=> explain select * from t_test;
                            QUERY PLAN
------------------------------------------------------------------
 Seq Scan on t_test  (cost=0.00..137316.62 rows=8388562 width=21)
(1 row)

Time: 0.474 ms
milano2019=> select pg_relation_size('t_test')/8192.0;
      ?column?
--------------------
 53431.000000000000
(1 row)

Time: 10.780 ms
milano2019=> select 1*53431 + 0.01*8388562;
 ?column?
-----------
 137316.62
(1 row)

Time: 0.209 ms
```


### Seq Scan on t_test costs with aggregation = (num_pages*seq_page_cost) + (num_tuples*cpu_tuple_cost) + (num_tuples*cpu_operator_cost)

```
milano2019=> explain select count(*) from t_test;
                              QUERY PLAN
-----------------------------------------------------------------------
 Aggregate  (cost=158288.02..158288.04 rows=1 width=8)
   ->  Seq Scan on t_test  (cost=0.00..137316.62 rows=8388562 width=0)
(2 rows)

Time: 3.422 ms
milano2019=> select 1*53431 + 0.01*8388562 + 0.0025*8388562;
  ?column?
-------------
 158288.0250
(1 row)

Time: 2.719 ms

milano2019=>
```